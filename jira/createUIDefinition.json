{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [],
    "steps": [
      {
        "name": "administrator",
        "bladeTitle": "Configure JIRA",
        "label": "Configure JIRA",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "adminEmail",
            "label": "Admin Email",
            "type": "Microsoft.Common.TextBox",
            "defaultValue": "smontgomery@atlassian.com",
            "constraints": {
              "required": true,
              "regex": "[^@]+@[^@]+\\.[A-z]{2,4}",
              "validationMessage": "You must specify an email address"
            }
          },
          {
            "name": "adminfullname",
            "label": "Admin Full name",
            "type": "Microsoft.Common.TextBox",
            "defaultValue": "Stephen Montgomery",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a full name"
            }
          },
          {
            "name": "adminUsername",
            "label": "Admin Username",
            "type": "Microsoft.Compute.UserNameTextBox",
            "defaultValue": "adminUser",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a username"
            },
            "osPlatform": "Linux"
          },
          {
            "name": "adminPassword",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "type": "Microsoft.Common.PasswordBox",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a password"
            }
          },
          {
            "name": "jiraClusterSize",
            "label": "JIRA Cluster",
            "type": "Microsoft.Common.DropDown",
            "toolTip": "See https://confluence.atlassian.com/enterprise/jira-sizing-guide-461504623.html",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Trial (Min HW)",
                  "value": "trial"
                },
                {
                  "label": "Small (25 Concurrent Users)",
                  "value": "small"
                },
                {
                  "label": "Medium (200 Concurrent Users)",
                  "value": "medium"
                },
                {
                  "label": "Large (600 Concurrent Users)",
                  "value": "large"
                },
                {
                  "label": "Enterprise (>2000 Concurrent Users)",
                  "value": "enterprise"
                }
              ],
              "required": true
            },
            "visible": true,
            "defaultValue": "Small (25 Concurrent Users)"
          },
          {
            "name": "monitoring",
            "bladeTitle": "Configure Monitoring",
            "label": "Configure Monitoring",
            "subLabel": {
              "preValidation": "To do",
              "postValidation": "Done"
            },
            "elements": [
              {
                "name": "enableEmailAlerts",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Enable Email Alerts",
                "defaultValue": "Yes",
                "toolTip": "Enable Email Alerts",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Yes",
                      "value": "yes"
                    },
                    {
                      "label": "No",
                      "value": "no"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "enableAppInsights",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Enable App Insights",
                "defaultValue": "Yes",
                "toolTip": "Enable App Insights",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Yes",
                      "value": "yes"
                    },
                    {
                      "label": "No",
                      "value": "no"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "allowedAppInsightsLocations",
                "type": "Microsoft.Common.TextBox",
                "label": "allowedAppInsightsLocations",
                "defaultValue": "eastus, westeurope, southeastasia, centralindia, canadacentral, southcentralus, northeurope, westus2, uksouth.",
                "visible": false
              },
              {
                "name": "appInsightsCheck",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('monitoring').enableAppInsights, 'yes'),  not(contains(steps('monitoring').allowedAppInsightsLocations, location())))]",
                "options": {
                  "icon": "Error",
                  "text": "[concat('App Insights product only available in regions: ', steps('monitoring').allowedAppInsightsLocations, ' Please disable or change resource group location!')]",
                  "uri": "https://azure.microsoft.com/en-gb/global-infrastructure/services/?products=monitor&regions=us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,canada-east,canada-central,non-regional,europe-north,europe-west,france-central,france-south,united-kingdom-south,united-kingdom-west,asia-pacific-east,asia-pacific-southeast,australia-central,australia-central-2,australia-east,australia-southeast,germany-non-regional,germany-central,germany-northeast,usgov-non-regional,us-dod-central,us-dod-east,usgov-arizona,usgov-iowa,usgov-texas,usgov-virginia,brazil-south,japan-east,japan-west,central-india,south-india,west-india,korea-central,korea-south"
                }
              },
              {
                "name": "enableAnalytics",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Enable Analytics for Gateway and DB?",
                "defaultValue": "Yes",
                "toolTip": "Enable Analytics for Gateway and DB?",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Yes",
                      "value": "yes"
                    },
                    {
                      "label": "No",
                      "value": "no"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "allowedAnalyticsLocations",
                "type": "Microsoft.Common.TextBox",
                "label": "allowedAnalyticsLocations",
                "defaultValue": "eastus, westeurope, southeastasia, centralindia, canadacentral, australiasoutheast, westcentralus, japaneast, uksouth.",
                "visible": false
              },
              {
                "name": "appAnalyticsCheck",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('monitoring').enableAnalytics, 'yes'), not(contains(steps('monitoring').allowedAnalyticsLocations, location())))]",
                "options": {
                  "icon": "Error",
                  "text": "[concat('Analytics products only available in regions: ', steps('monitoring').allowedAnalyticsLocations, ' Please disable or change resource group location!')]",
                  "uri": "https://azure.microsoft.com/en-gb/global-infrastructure/services/?products=monitor&regions=us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,canada-east,canada-central,non-regional,europe-north,europe-west,france-central,france-south,united-kingdom-south,united-kingdom-west,asia-pacific-east,asia-pacific-southeast,australia-central,australia-central-2,australia-east,australia-southeast,germany-non-regional,germany-central,germany-northeast,usgov-non-regional,us-dod-central,us-dod-east,usgov-arizona,usgov-iowa,usgov-texas,usgov-virginia,brazil-south,japan-east,japan-west,central-india,south-india,west-india,korea-central,korea-south"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "database",
        "bladeTitle": "Configure Database",
        "label": "Configure Database",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "hasDatabase",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Do you have an existing database (in same location/resource group)?",
            "toolTip": "If you already have a database that you would like to use for your JIRA instance, you can enter it here.",
            "defaultValue": "No",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "yes"
                },
                {
                  "label": "No",
                  "value": "no"
                }
              ],
              "required": true
            }
          },
          {
            "name": "dbType",
            "label": "Database Type",
            "type": "Microsoft.Common.OptionsGroup",
            "defaultValue": "Azure SQL DB",
            "toolTip": "",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Azure SQL DB",
                  "value": "Azure SQL DB"
                },
                {
                  "label": "Azure DB for PostgreSQL",
                  "value": "Azure DB for PostgreSQL"
                }
              ],
              "required": true
            },
            "visible": "[equals('yes', steps('database').hasDatabase)]"
          },
          {
            "name": "dbHost",
            "label": "Database Server",
            "type": "Microsoft.Common.TextBox",
            "toolTip": "",
            "constraints": {
              "required": true,
              "validationMessage": ""
            },
            "visible": "[equals('yes', steps('database').hasDatabase)]"
          },
          {
            "name": "dbPort",
            "label": "Database Port",
            "type": "Microsoft.Common.TextBox",
            "defaultValue": "1433",
            "toolTip": "",
            "constraints": {
              "required": true,
              "regex": "[0-9]*",
              "validationMessage": ""
            },
            "visible": "[equals('yes', steps('database').hasDatabase)]"
          },
          {
            "name": "dbDatabase",
            "label": "Database Name",
            "type": "Microsoft.Common.TextBox",
            "toolTip": "",
            "defaultValue": "jiradatabase",
            "constraints": {
              "required": true,
              "regex": "[a-z]*",
              "validationMessage": ""
            },
            "visible": "[equals('yes', steps('database').hasDatabase)]"
          },
          {
            "name": "dbSchema",
            "label": "Database Schema",
            "type": "Microsoft.Common.TextBox",
            "toolTip": "",
            "defaultValue": "jiraschema",
            "constraints": {
              "required": true,
              "regex": "[a-z]*",
              "validationMessage": ""
            },
            "visible": "[equals('yes', steps('database').hasDatabase)]"
          },
          {
            "name": "dbUsername",
            "type": "Microsoft.Common.TextBox",
            "label": "Username",
            "defaultValue": "jiraadmin",
            "constraints": {
              "required": true,
              "regex": "^(?!admin$|administrator$|sa$|root$|dbmanager$|loginmanager$|dbo$|guest$|information_schema$|sys$|db_accessadmin$|db_backupoperator$|db_datareader$|db_datawriter$|db_ddladmin$|db_denydatareader$|db_denydatawriter$|db_owner$|db_securityadmin$|public$)[a-zA-Z][a-zA-Z0-9]{1,9}$",
              "validationMessage": "This username needs to be a SQL Identifier - it can't be a typical username like admin, adminstrator, sa, root, dbmanager, loginmanager, dbo, guest, or public. It also can't begin with numbers or symbols, and can't include whitespaces, unicode characters, or non-alphabetic characters."
            }
          },
          {
            "name": "dbPassword",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "constraints": {
              "required": true,
              "regex": "^(?=.*[A-Z])(?=.*[!@#$%])(?=.*[0-9])(?=.*[a-z]).{8,16}$",
              "validationMessage": "This password must be between 8 and 16 characters long, and must contain at least one uppercase letter, one lowercase letter, one number (0-9), and one non-alphanumeric character (!, $, #, %, etc.)."
            }
          }
        ]
      },
      {
        "name": "ssh",
        "bladeTitle": "Configure SSH Access",
        "label": "Configure SSH Access",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "jumpboxSshSection",
            "label": "Setup SSH Access to the Jumpbox",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "jumpboxSshKey",
                "type": "Microsoft.Compute.CredentialsCombo",
                "label": {
                  "authenticationType": "Authentication type",
                  "password": "Password",
                  "confirmPassword": "Confirm password",
                  "sshPublicKey": "SSH public key"
                },
                "toolTip": {
                  "authenticationType": "",
                  "password": "",
                  "sshPublicKey": ""
                },
                "constraints": {
                  "required": true
                },
                "options": {
                  "hideConfirmation": false,
                  "hidePassword": true
                },
                "osPlatform": "Linux",
                "defaultValue": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDzHL0anA/uLc70WunKBtY9TckYliFDB68jXsHb9z5os/8gcTacocaFzFlx/e6C2kJNeBh2IA1CZ5rInE6ice2B7dyuwP7JCSmZHk7ybMtRiE0SPy8yk0BwNnMTDctnStTG6VdLAm3tja7h6q84g/hlzyDQs4r66agKNdm4NOxoVxMsXK3OwLRfIrhPjEBiEHYuLg77LB60O9AKzKvJOe2SlMhfuX1+RTJys6SPhf88YTo9xBwu8eXaGYrUawpQtW8ik6PL3PdBT4wMx9JJCTd7w3EKvbf9qgnc4wDaoFC3fIUgmaVfIkCMx7yTAoL0P5TIDkX46IR7hWVjOU6eyKrz monty@monty-XPS-15-9570",
                "visible": true
              }
            ]
          },
          {
            "name": "nodeSshSection",
            "label": "Setup SSH Access to the JIRA Nodes",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "nodeUsername",
                "label": "Username",
                "type": "Microsoft.Compute.UserNameTextBox",
                "toolTip": "This will be the username used to SSH into each JIRA node from the jumpbox.",
                "defaultValue": "jiraadmin",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "nodePassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Password",
                  "confirmPassword": "Confirm password"
                },
                "toolTip": "This will be the password used to SSH into each JIRA node from the jumpbox.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a password"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "domain",
        "bladeTitle": "Configure Domain",
        "label": "Configure Domain",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "cnameSection",
            "label": "Set up Domain",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "hascname",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Do you have an existing registered CNAME?",
                "toolTip": "If you already have a CNAME registered with a domain name provider that you would like to use for your JIRA instance, you can enter it here.",
                "defaultValue": "No",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Yes",
                      "value": "yes"
                    },
                    {
                      "label": "No",
                      "value": "no"
                    }
                  ],
                  "required": true
                }
              },
              {
                "name": "cname",
                "label": "Existing CNAME",
                "type": "Microsoft.Common.TextBox",
                "constraints": {
                  "required": true,
                  "regex": ".+\\..+",
                  "validationMessage": "You must specify a valid domain name"
                },
                "visible": "[equals('yes', steps('domain').cnameSection.hascname)]"
              }
            ]
          },
          {
            "name": "sslSection",
            "label": "Set up SSL",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "hasssl",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Do you want to use SSL?",
                "toolTip": "If you have a SSL PFX certificate and password, you can enter it here.",
                "defaultValue": "No",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Yes",
                      "value": "yes"
                    },
                    {
                      "label": "No",
                      "value": "no"
                    }
                  ],
                  "required": true
                }
              },
              {
                "name": "sslBase64EncodedPfxCertificate",
                "type": "Microsoft.Common.TextBox",
                "label": "Base64 Encoded PFX Certificate",
                "toolTip": "Base64 Encoded PFX Certificate",
                "constraints": {
                  "required": true
                },
                "visible": "[equals('yes', steps('domain').sslSection.hasssl)]"
              },
              {
                "name": "sslPfxCertificatePassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Password",
                  "confirmPassword": "Confirm password"
                },
                "toolTip": "This will be the password used for the PFX",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a password"
                },
                "visible": "[equals('yes', steps('domain').sslSection.hasssl)]"
              }
            ]
          }
        ]
      },
      {
        "name": "monitoring",
        "bladeTitle": "Configure Monitoring",
        "label": "Configure Monitoring",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "locationInfo",
            "type": "Microsoft.Common.TextBlock",
            "visible": true,
            "options": {
              "text": "[concat('Location: ', location())]"
            }
          },
          {
            "name": "enableEmailAlerts",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Email Alerts",
            "defaultValue": "Yes",
            "toolTip": "Enable Email Alerts",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "yes"
                },
                {
                  "label": "No",
                  "value": "no"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "enableAppInsights",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable App Insights",
            "defaultValue": "Yes",
            "toolTip": "Enable App Insights",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "yes"
                },
                {
                  "label": "No",
                  "value": "no"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "appInsightsCheck",
            "type": "Microsoft.Common.InfoBox",
            "visible": "[and(equals(steps('monitoring').enableAppInsights, 'yes'),  not(contains('eastus, westeurope, southeastasia, centralindia, canadacentral, southcentralus, northeurope, westus2, uksouth', location())))]",
            "options": {
              "icon": "Error",
              "text": "App Insights product only available in regions: eastus, westeurope, southeastasia, centralindia, canadacentral, southcentralus, northeurope, westus2, uksouth. Please disable or change resource group location!",
              "uri": "https://azure.microsoft.com/en-gb/global-infrastructure/services/?products=monitor&regions=us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,canada-east,canada-central,non-regional,europe-north,europe-west,france-central,france-south,united-kingdom-south,united-kingdom-west,asia-pacific-east,asia-pacific-southeast,australia-central,australia-central-2,australia-east,australia-southeast,germany-non-regional,germany-central,germany-northeast,usgov-non-regional,us-dod-central,us-dod-east,usgov-arizona,usgov-iowa,usgov-texas,usgov-virginia,brazil-south,japan-east,japan-west,central-india,south-india,west-india,korea-central,korea-south"
            }
          },
          {
            "name": "enableAnalytics",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Analytics for Gateway and DB?",
            "defaultValue": "Yes",
            "toolTip": "Enable Analytics for Gateway and DB?",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "yes"
                },
                {
                  "label": "No",
                  "value": "no"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "appAnalyticsCheck",
            "type": "Microsoft.Common.InfoBox",
            "visible": "[and(equals(steps('monitoring').enableAnalytics, 'yes'), not(contains('eastus, westeurope, southeastasia, centralindia, canadacentral, australiasoutheast, westcentralus, japaneast, uksouth', location())))]",
            "options": {
              "icon": "Error",
              "text": "Analytics products only available in regions: eastus, westeurope, southeastasia, centralindia, canadacentral, australiasoutheast, westcentralus, japaneast, uksouth. Please disable or change resource group location!",
              "uri": "https://azure.microsoft.com/en-gb/global-infrastructure/services/?products=monitor&regions=us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,canada-east,canada-central,non-regional,europe-north,europe-west,france-central,france-south,united-kingdom-south,united-kingdom-west,asia-pacific-east,asia-pacific-southeast,australia-central,australia-central-2,australia-east,australia-southeast,germany-non-regional,germany-central,germany-northeast,usgov-non-regional,us-dod-central,us-dod-east,usgov-arizona,usgov-iowa,usgov-texas,usgov-virginia,brazil-south,japan-east,japan-west,central-india,south-india,west-india,korea-central,korea-south"
            }
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "_artifactsLocation": "",
      "_artifactsLocationSasToken": "",

      "jiraAdminUserName": "[steps('administrator').adminUsername]",
      "jiraAdminUserPassword": "[steps('administrator').adminPassword]",
      "jiraAdminUserEmail": "[steps('administrator').username]",
      "jiraAdminUserFullname": "[steps('administrator').adminfullname]",

      "dbCreateNew": "[equals('no', steps('database').hasDatabase)]",
      "dbUsername": "[steps('database').dbUsername]",
      "dbPassword": "[steps('database').dbPassword]",

      "dbDatabase": "[steps('database').dbDatabase]",
      "dbHost": "[steps('database').dbHost]",
      "dbPort": "[steps('database').dbPort]",
      "dbSchema": "[steps('database').dbSchema]",
      "dbType": "[steps('database').dbType]",
      
      "jumpboxSshKey": "[steps('ssh').jumpboxSshSection.jumpboxSshKey.sshPublicKey]",
      "clusterSshUser": "[steps('ssh').nodeSshSection.nodeUsername]",
      "clusterSshPassword": "[steps('ssh').nodeSshSection.nodePassword]",

      "cname": "[steps('domain').cnameSection.cname]",
      "sslBase64EncodedPfxCertificate": "[steps('domain').sslSection.sslBase64EncodedPfxCertificate]",
      "sslPfxCertificatePassword": "[steps('domain').sslSection.sslPfxCertificatePassword]",

      "enableEmailAlerts": "[equals(steps('monitoring').enableEmailAlerts, 'yes')]",
      "enableApplicationInsights": "[equals(steps('monitoring').enableAppInsights, 'yes')]",
      "enableAnalytics": "[equals(steps('monitoring').enableAnalytics, 'yes')]"
    }
  }
}