{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "hascname",
        "type": "Microsoft.Common.OptionsGroup",
        "label": "Do you have an existing registered CNAME?",
        "toolTip": "If you already have a CNAME registered with a domain name provider that you would like to use for your JIRA instance, you can enter it here.",
        "defaultValue": "No",
        "constraints": {
          "allowedValues": [
            {
              "label": "Yes",
              "value": "yes"
            },
            {
              "label": "No",
              "value": "no"
            }
          ]
        }
      },
      {
        "name": "cname",
        "label": "Existing CNAME",
        "type": "Microsoft.Common.TextBox",
        "toolTip": "Once JIRA is deployed, you'll need to update your CNAME record to reference the JIRA endpoint generated by Azure.",
        "constraints": {
          "required": true,
          "regex": ".+\\..+",
          "validationMessage": "You must specify a valid domain name"
        },
        "visible": "[equals('yes', basics('hascname'))]"
      }
    ],
    "steps": [
      {
        "name": "administrator",
        "bladeTitle": "JIRA admin account",
        "label": "Set up the JIRA admin account",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "email",
            "label": "Email",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true,
              "regex": "[^@]+@[^@]+\\.[A-z]{2,4}",
              "validationMessage": "You must specify an email address"
            }
          },
          {
            "name": "fullname",
            "label": "Full name",
            "type": "Microsoft.Common.TextBox",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a full name"
            }
          },
          {
            "name": "username",
            "label": "Username",
            "type": "Microsoft.Compute.UserNameTextBox",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a username"
            },
            "osPlatform": "Linux"
          },
          {
            "name": "password",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "type": "Microsoft.Common.PasswordBox",
            "constraints": {
              "required": true,
              "validationMessage": "You must specify a password"
            }
          }
        ]
      },
      {
        "name": "infrastructure",
        "bladeTitle": "JIRA node configuration",
        "label": "Set up your JIRA nodes",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "clustersize",
            "label": "Number of nodes",
            "type": "Microsoft.Common.TextBox",
            "defaultValue": "2",
            "toolTip": "Pick how many JIRA nodes to run in the cluster.",
            "constraints": {
              "required": true,
              "regex": "^[2-6]$",
              "validationMessage": "Supported cluster sizes are between 2 and 6 nodes"
            }
          },
          {
            "name": "nodesize",
            "label": "Node size",
            "type": "Microsoft.Compute.SizeSelector",
            "toolTip": "Pick the virtual machine size to use for each node.",
            "recommendedSizes": [
              "Standard_DS3_v2"
            ],
            "constraints": {
              "allowedSizes": [
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_F4s",
                "Standard_F8s"
              ]
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "Canonical",
              "offer": "UbuntuServer",
              "sku": "17.04"
            },
            "count": "[steps('infrastructure').clustersize]"
          }
        ]
      },
      {
        "name": "database",
        "bladeTitle": "Database admin",
        "label": "Set up the database admin account",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "username",
            "type": "Microsoft.Common.TextBox",
            "label": "Username",
            "constraints": {
              "required": true,
              "regex": "^(?!admin$|administrator$|sa$|root$|dbmanager$|loginmanager$|dbo$|guest$|information_schema$|sys$|db_accessadmin$|db_backupoperator$|db_datareader$|db_datawriter$|db_ddladmin$|db_denydatareader$|db_denydatawriter$|db_owner$|db_securityadmin$|public$)[a-zA-Z][a-zA-Z0-9]{1,9}$",
              "validationMessage": "This username needs to be a SQL Identifier - it can't be a typical username like admin, adminstrator, sa, root, dbmanager, loginmanager, dbo, guest, or public. It also can't begin with numbers or symbols, and can't include whitespaces, unicode characters, or non-alphabetic characters."
            }
          },
          {
            "name": "password",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "constraints": {
              "required": true,
              "regex": "^(?=.*[A-Z])(?=.*[!@#$%])(?=.*[0-9])(?=.*[a-z]).{8,16}$",
              "validationMessage": "This password must be between 8 and 16 characters long, and must contain at least one uppercase letter, one lowercase letter, one number (0-9), and one non-alphanumeric character (!, $, #, %, etc.)."
            }
          }
        ]
      },
      {
        "name": "ssh",
        "bladeTitle": "SSH access",
        "label": "Set up SSH access",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "jumpbox",
            "label": "Set up access to the jumpbox",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "jumpboxUsername",
                "label": "Username",
                "type": "Microsoft.Compute.UserNameTextBox",
                "toolTip": "This will be the username used to SSH into the jumpbox from your own machine.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify an SSH username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "credentials",
                "type": "Microsoft.Compute.CredentialsCombo",
                "osPlatform": "Linux",
                "label": {
                  "authenticationType": "",
                  "password": "",
                  "confirmPassword": "",
                  "sshPublicKey": "Public key"
                },
                "toolTip": {
                  "authenticationType": "",
                  "password": "",
                  "sshPublicKey": "This will be the public key used to SSH into the jumpbox from your own machine."
                },
                "options": {
                  "hidePassword": true
                },
                "constraints": {
                  "required": true
                }
              }
            ]
          },
          {
            "name": "node",
            "label": "Set up access to the JIRA nodes",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "nodeUsername",
                "label": "Username",
                "type": "Microsoft.Compute.UserNameTextBox",
                "toolTip": "This will be the username used to SSH into each JIRA node from the jumpbox.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "nodePassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Password",
                  "confirmPassword": "Confirm password"
                },
                "toolTip": "This will be the password used to SSH into each JIRA node from the jumpbox.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a password"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "cname": "[basics('cname')]",
      "jiraVmSize": "[steps('infrastructure').nodesize]",
      "jumpboxSshUser": "[steps('ssh').jumpbox.jumpboxUsername]",
      "jumpboxSshKey": "[steps('ssh').jumpbox.credentials.sshPublicKey]",
      "nodeSshUser": "[steps('ssh').node.nodeUsername]",
      "nodeSshPassword": "[steps('ssh').node.nodePassword]",
      "dbUsername": "[steps('database').username]",
      "dbPassword": "[steps('database').password]",
      "userName": "[steps('administrator').username]",
      "userFullname": "[steps('administrator').fullname]",
      "userEmail": "[steps('administrator').email]",
      "userCredential": "[steps('administrator').password]",
      "clusterSize": "[int(steps('infrastructure').clustersize)]"
    }
  }
}