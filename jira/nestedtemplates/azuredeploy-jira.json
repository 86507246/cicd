{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "Base URL for Marketplace"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Scripts storage access token"
            }
        },
        "location": {
            "type": "string"
        },
        "clusterSize": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "The number of JIRA nodes in the cluster"
            }
        },
        "clusterVmSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "metadata": {
                "description": "The size of the virtual machine used for each JIRA node."
            }
        },
        "clusterSshUser": {
            "type": "string",
            "defaultValue": "jiraadmin",
            "metadata": {
                "description": "The username used to SSH into each JIRA node from the jumpbox."
            }
        },
        "clusterSshPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password used to SSH into each JIRA node from the jumpbox."
            }
        },
        "cname": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "An existing CNAME that will be used to access the JIRA instance."
            }
        },
        "dbCreateNew": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Creates new database or attempts to use existing specified database"
            }
        },
        "dbType": {
            "type": "string",
            "allowedValues": [
                "sqlserver",
                "postgres",
                "mysql"
            ],
            "defaultValue": "sqlserver",
            "metadata": {
                "description": "Database type"
            }
        },
        "dbHost": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Host name of DB server"
            }
        },
        "dbPort": {
            "type": "string",
            "defaultValue": "[if(equals(parameters('dbType'), 'sqlserver'), '1433', if(equals(parameters('dbType'), 'postgres'), '5432', '3306'))]",
            "metadata": {
                "description": "Database port to use"
            }
        },
        "dbDatabase": {
            "type": "string",
            "defaultValue": "jira",
            "metadata": {
                "description": "Database name"
            }
        },
        "dbSchema": {
            "type": "string",
            "defaultValue": "[if(parameters('dbCreateNew'), if(equals(parameters('dbType'), 'sqlserver'), 'jiraschema', 'public'), 'jiraschema')]",
            "metadata": {
                "description": "Database schema to use"
            }
        },
        "dbUsername": {
            "type": "string",
            "metadata": {
                "description": "Database username"
            }
        },
        "dbPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Database password"
            }
        },
        "dbTier": {
            "type": "string",
            "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
            ],
            "defaultValue": "Standard",
            "metadata": {
                "description": "The database service tier"
            }
        },
        "dbTierSize": {
            "type": "string",
            "allowedValues": [
                "Basic",
                "S1",
                "S2",
                "S3",
                "S4",
                "S6",
                "S7",
                "S9",
                "S12",
                "P1",
                "P2",
                "P4",
                "P6",
                "P11",
                "P15"
            ],
            "defaultValue": "S2",
            "metadata": {
                "description": "The database service tier size"
            }
        },
        "postgresDbTier": {
            "type": "string",
            "allowedValues": [
                "General Purpose",
                "Memory Optimized"
            ],
            "defaultValue": "General Purpose",
            "metadata": {
                "description": "The database service tier"
            }
        },
        "postgresDbStorage": {
            "type": "int",
            "defaultValue": 102400,
            "minValue": 102400,
            "maxValue": 4194304,
            "metadata": {
                "description": "The storage size of the PostgresSQL Managed Database Service."
            }
        },
        "jiraAdminUserName": {
            "type": "string",
            "defaultValue": "admin"
        },
        "jiraAdminUserPassword": {
            "type": "securestring"
        },
        "jiraAdminUserFullname": {
            "type": "string"
        },
        "jiraAdminUserEmail": {
            "type": "string"
        },
        "jiraAppTitle": {
            "type": "string",
            "defaultValue": "Atlassian Jira"
        },
        "appGtwyClusterSize": {
            "type": "int",
            "allowedValues": [
                1,
                2,
                3,
                4,
                5,
                6
            ],
            "defaultValue": 2,
            "minValue": 1,
            "metadata": {
                "description": "The number of nodes for the App Gateway cluster"
            }
        },
        "appGtwyTier": {
            "type": "string",
            "allowedValues": [
                "Standard_Small",
                "Standard_Medium",
                "Standard_Large"
            ],
            "defaultValue": "Standard_Medium",
            "metadata": {
                "description": "The application gateway size"
            }
        },
        "vnetName": {
            "type": "string"
        },
        "appSubnetName": {
            "type": "string"
        },
        "gtwySubnetName": {
            "type": "string"
        },
        "jumpboxName": {
            "type": "string"
        },
        "jumpboxPublicIpAddress": {
            "type": "string"
        },
        "sslBase64EncodedPfxCertificate": {
            "type": "string",
            "defaultValue": ""
        },
        "sslPfxCertificatePassword": {
            "type": "string",
            "defaultValue": ""
        },
        "enableApplicationInsights": {
            "type": "bool",
            "defaultValue": true
        },
        "enableAnalytics": {
            "type": "bool",
            "defaultValue": true
        },
        "enableAcceleratedNetworking": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                 "description": "Enable accelerated networking? Needs to be a supported instance type."
             }
         }
    },
    "variables": {
        "namespace": "jira",
        "dbTemplateUri": "[uri(parameters('_artifactsLocation'), concat(if(equals(parameters('dbType'),'sqlserver'),'nestedtemplates/azuredeploy-db.json','nestedtemplates/azuredeploy-postgres-db.json'), parameters('_artifactsLocationSasToken')))]",
        "vmssTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-jira-vmss.json', parameters('_artifactsLocationSasToken')))]",
        "byodbTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-byodb.json', parameters('_artifactsLocationSasToken')))]",
        "appGtwyTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-jira-gtwy.json', parameters('_artifactsLocationSasToken')))]",
        "appInsightsTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-app-insights.json', parameters('_artifactsLocationSasToken')))]",
        "analyticsTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-analytics.json', parameters('_artifactsLocationSasToken')))]",
        "tags": {
            "vendor": "Atlassian",
            "product": "JIRA",
            "provider": "2F0AF47A-92C7-413A-9009-C3815BFF7AF6"
        },
        "jira": {
            "storage": {
                "name": "[concat(variables('namespace'), 'storage', uniqueString(resourceGroup().id))]"
            },
            "cluster": {
                "name": "[concat(variables('namespace'), 'cluster')]",
                "tier": "Standard",
                "vm": {
                    "size": "[parameters('clusterVmSize')]",
                    "user": "[parameters('clusterSshUser')]",
                    "pass": "[parameters('clusterSshPassword')]",
                    "image": {
                        "publisher": "Canonical",
                        "offer": "UbuntuServer",
                        "sku": "16.04-LTS",
                        "version": "latest"
                    },
                    "osdisk": {
                        "type": "Premium_LRS",
                        "size": "100"
                    },
                    "datadisk": {
                        "type": "Premium_LRS",
                        "caching": "ReadWrite",
                        "size": "100"
                    }
                }
            }
        },
        "workspace": {
            "name": "[concat(variables('namespace'), '-Workspace-', uniqueString(resourceGroup().id))]",
            "sku": "free",
            "retentionInDays": 7
        },
        "gtwyIpName": "[concat(variables('namespace'), '-appgtwyip-', uniqueString(resourceGroup().id))]",
        "gtwyName": "[if(empty(parameters('sslBase64EncodedPfxCertificate')), concat(variables('namespace'), 'appgateway'), concat(variables('namespace'), 'appgateway-https'))]",
        "gtwyAddressPoolName": "[concat(variables('namespace'), 'appgwaddrpool')]",
        "dbTemplate": "[if(equals(parameters('dbType'),'sqlserver'), 'sqlDbTemplate', 'postgresDbTemplate')]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[variables('workspace').name]",
            "apiVersion": "2015-11-01-preview",
            "condition": "[parameters('enableAnalytics')]",
            "location": "[parameters('location')]",
            "scale": null,
            "properties": {
                "sku": {
                    "name": "[variables('workspace').sku]"
                },
                "retentionInDays": "[variables('workspace').retentionInDays]"
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "sqlDbTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[and(parameters('dbCreateNew'), equals(parameters('dbType'), 'sqlserver'))]",
            "dependsOn": [
                "[variables('workspace').name]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('dbTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "dbServerName": {
                        "value": "[parameters('dbHost')]"
                    },
                    "dbDatabaseName": {
                        "value": "[parameters('dbDatabase')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "dbTier": {
                        "value": "[parameters('dbTier')]"
                    },
                    "dbTierSize": {
                        "value": "[parameters('dbTierSize')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "appSubnetName": {
                        "value": "[parameters('appSubnetName')]"
                    },
                    "workspaceName": {
                        "value": "[variables('workspace').name]"
                    },
                    "enableAnalytics": {
                        "value": "[parameters('enableAnalytics')]"
                    },
                    "jumpboxPublicIpAddress": {
                        "value": "[parameters('jumpboxPublicIpAddress')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "postgresDbTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[and(parameters('dbCreateNew'), equals(parameters('dbType'), 'postgres'))]",
            "dependsOn": [],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "uri": "[variables('dbTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "dbServerName": {
                        "value": "[parameters('dbHost')]"
                    },
                    "dbDatabaseName": {
                        "value": "[parameters('dbDatabase')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "postgresDbTier": {
                        "value": "[parameters('postgresDbTier')]"
                    },
                    "postgresDbStorage": {
                        "value": "[parameters('postgresDbStorage')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "appSubnetName": {
                        "value": "[parameters('appSubnetName')]"
                    },
                    "jumpboxPublicIpAddress": {
                        "value": "[parameters('jumpboxPublicIpAddress')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "byodbTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[not(parameters('dbCreateNew'))]",
            "dependsOn": [
                "[variables('workspace').name]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('byodbTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "dbType": {
                        "value": "[parameters('dbType')]"
                    },
                    "dbServerName": {
                        "value": "[parameters('dbHost')]"
                    },
                    "dbDatabaseName": {
                        "value": "[parameters('dbDatabase')]"
                    },
                    "dbPort": {
                        "value": "[parameters('dbPort')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "appSubnetName": {
                        "value": "[parameters('appSubnetName')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "appInsightsTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[parameters('enableApplicationInsights')]",
            "dependsOn": [
                "[variables('workspace').name]",
                "[variables('dbTemplate')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('appInsightsTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "analyticsTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[parameters('enableAnalytics')]",
            "dependsOn": [
                "[variables('workspace').name]",
                "[variables('dbTemplate')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('analyticsTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "workspaceName": {
                        "value": "[variables('workspace').name]"
                    },
                    "dbType": {
                        "value": "[parameters('dbType')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2018-08-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('gtwyIpName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Basic"
            },
            "zones": [],
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4,
                "dnsSettings": {
                    "domainNameLabel": "[variables('gtwyIpName')]"
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "appGtwyTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[variables('workspace').name]",
                "[variables('gtwyIpName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('appGtwyTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "gtwyIpName": {
                        "value": "[variables('gtwyIpName')]"
                    },
                    "gtwyName": {
                        "value": "[variables('gtwyName')]"
                    },
                    "gtwyAddressPoolName": {
                        "value": "[variables('gtwyAddressPoolName')]"
                    },
                    "appGtwyClusterSize": {
                        "value": "[parameters('appGtwyClusterSize')]"
                    },
                    "appGtwyTier": {
                        "value": "[parameters('appGtwyTier')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "gtwySubnetName": {
                        "value": "[parameters('gtwySubnetName')]"
                    },
                    "sslBase64EncodedPfxCertificate": {
                        "value": "[parameters('sslBase64EncodedPfxCertificate')]"
                    },
                    "sslPfxCertificatePassword": {
                        "value": "[parameters('sslPfxCertificatePassword')]"
                    },
                    "workspaceName": {
                        "value": "[variables('workspace').name]"
                    },
                    "enableAnalytics": {
                        "value": "[parameters('enableAnalytics')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "vmssTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', variables('jira').storage.name)]",
                "[variables('dbTemplate')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vmssTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "clusterSize": {
                        "value": "[parameters('clusterSize')]"
                    },
                    "clusterVmSize": {
                        "value": "[parameters('clusterVmSize')]"
                    },
                    "clusterSshUser": {
                        "value": "[parameters('clusterSshUser')]"
                    },
                    "clusterSshPassword": {
                        "value": "[parameters('clusterSshPassword')]"
                    },
                    "cname": {
                        "value": "[parameters('cname')]"
                    },
                    "dbCreateNew": {
                        "value": "[parameters('dbCreateNew')]"
                    },
                    "dbType": {
                        "value": "[parameters('dbType')]"
                    },
                    "dbPort": {
                        "value": "[parameters('dbPort')]"
                    },
                    "dbDatabase": {
                        "value": "[parameters('dbDatabase')]"
                    },
                    "dbSchema": {
                        "value": "[parameters('dbSchema')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "jiraAdminUserName": {
                        "value": "[parameters('jiraAdminUserName')]"
                    },
                    "jiraAdminUserPassword": {
                        "value": "[parameters('jiraAdminUserPassword')]"
                    },
                    "jiraAdminUserFullname": {
                        "value": "[parameters('jiraAdminUserFullname')]"
                    },
                    "jiraAdminUserEmail": {
                        "value": "[parameters('jiraAdminUserEmail')]"
                    },
                    "jiraAppTitle": {
                        "value": "[parameters('jiraAppTitle')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "appSubnetName": {
                        "value": "[parameters('appSubnetName')]"
                    },
                    "jumpboxName": {
                        "value": "[parameters('jumpboxName')]"
                    },
                    "sslBase64EncodedPfxCertificate": {
                        "value": "[parameters('sslBase64EncodedPfxCertificate')]"
                    },
                    "appInsightsInstrumentKey": {
                        "value": "[if(parameters('enableApplicationInsights'), reference('appInsightsTemplate').outputs.instrumentkey.value, '')]"
                    },
                    "gtwyName": {
                        "value": "[variables('gtwyName')]"
                    },
                    "gtwyAddressPoolName": {
                        "value": "[variables('gtwyAddressPoolName')]"
                    },
                    "jiraBaseUrl": {
                        "value": "[if(not(empty(parameters('cname'))), parameters('cname'), reference(variables('gtwyIpName')).dnsSettings.fqdn)]"
                    },
                    "jiraDbServerName": {
                        "value": "[if(parameters('dbCreateNew'), reference(variables('dbTemplate')).outputs.serverName.value, parameters('dbHost'))]"
                    },
                    "storageAccessKey": {
                        "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts/', variables('jira').storage.name), '2017-06-01').keys[0].value]"
                    },
                    "enableAcceleratedNetworking": {
                        "value": "[parameters('enableAcceleratedNetworking')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2018-07-01",
            "name": "[variables('jira').storage.name]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_GRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {},
            "tags": "[variables('tags')]"
        }
    ],
    "outputs": {
        "jdbcUrl": {
            "type": "string",
            "value": "[if(parameters('dbCreateNew'), reference(variables('dbTemplate')).outputs.jdbcUrl.value, reference('byodbTemplate').outputs.jdbcUrl.value)]"
        },
        "jiraAppEndpoint": {
            "type": "string",
            "value": "[reference(variables('gtwyIpName')).dnsSettings.fqdn]"
        },
        "gtwyIpName": {
            "type": "string",
            "value": "[variables('gtwyIpName')]"
        },
        "gtwyName": {
            "type": "string",
            "value": "[variables('gtwyName')]"
        },
        "storageAccountName": {
            "type": "string",
            "value": "[variables('jira').storage.name]"
        },
        "clusterName": {
            "type": "string",
            "value": "[variables('jira').cluster.name]"
        },
        "appInsightsName": {
            "type": "string",
            "value": "[if(parameters('enableApplicationInsights'), reference('appInsightsTemplate').outputs.appInsightsName.value, '')]"
        },
        "dbDatabaseServerName": {
            "type": "string",
            "value": "[parameters('dbHost')]"
        },
        "dbDatabaseName": {
            "type": "string",
            "value": "[parameters('dbDatabase')]"
        }
    }
}