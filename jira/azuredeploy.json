{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "metadata": {
                "description": "Azure region to deploy to."
            },
            "minLength": 5
        },
        "_artifactsLocation": {
            "type": "string",
            "defaultValue": "[deployment().properties.templateLink.uri]",
            "metadata": {
                "description": "Base URL for Marketplace"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Scripts storage access token"
            }
        },
        "cname": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "CNAME to use"
            }
        },
        "clusterVmSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_F4s_v2",
                "Standard_F8s_v2",
                "Standard_F16s_v2",
                "Standard_F32s_v2",
                "Standard_F64s_v2",
                "Standard_F72s_v2",
                "Standard_E8s_v3",
                "Standard_E16s_v3",
                "Standard_E20s_v3",
                "Standard_E32s_v3"
            ],
            "metadata": {
                "description": "The size of the virtual machine used for each JIRA node."
            }
        },
        "jumpboxVmSize": {
            "type": "string",
            "defaultValue": "Standard_B1s",
            "metadata": {
                "description": "The size of the virtual machine used for the jumpbox box."
            }
        },
        "jumpboxSshKey": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The public key for the jumpbox SSH user. Usually the pasted contents of your machines public key ie ~/.ssh/id_rsa.pub"
            },
            "minLength": 300
        },
        "clusterSshUser": {
            "type": "string",
            "defaultValue": "jiraadmin",
            "metadata": {
                "description": "The username used to SSH into each JIRA node from the jumpbox."
            }
        },
        "clusterSshPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password used to SSH into each JIRA node from the jumpbox."
            },
            "minLength": 5
        },
        "dbCreateNew": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Creates new database or attempts to use existing specified database (has to be in same resource group and location as the target deployment)"
            }
        },
        "dbType": {
            "type": "string",
            "allowedValues": [
                "Azure SQL DB",
                "Azure DB for PostgreSQL"
            ],
            "defaultValue": "Azure SQL DB",
            "metadata": {
                "description": "Database type"
            }
        },
        "dbHost": {
            "type": "string",
            "defaultValue": "AUTO-GENERATED",
            "metadata": {
                "description": "Host name of DB server. Will be autogenerated if a new DB is to be created"
            }
        },
        "dbPort": {
            "type": "string",
            "defaultValue": "1433",
            "metadata": {
                "description": "Database port to use. 1433 for MS SQL, 5432 for Postgres, 3306 for MySQL"
            }
        },
        "dbDatabase": {
            "type": "string",
            "defaultValue": "jiradatabase",
            "metadata": {
                "description": "Database name"
            }
        },
        "dbSchema": {
            "type": "string",
            "defaultValue": "jiraschema",
            "metadata": {
                "description": "Database schema to use"
            }
        },
        "dbUsername": {
            "type": "string",
            "defaultValue": "jira",
            "metadata": {
                "description": "Database username"
            }
        },
        "dbPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Database password"
            }
        },
        "dbTier": {
            "type": "string",
            "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
            ],
            "defaultValue": "Standard",
            "metadata": {
                "description": "The database service tier"
            }
        },
        "dbTierSize": {
            "type": "string",
            "allowedValues": [
                "Basic",
                "S1",
                "S2",
                "S3",
                "S4",
                "S6",
                "S7",
                "S9",
                "S12",
                "P1",
                "P2",
                "P4",
                "P6",
                "P11",
                "P15"
            ],
            "defaultValue": "S2",
            "metadata": {
                "description": "The database service tier size"
            }
        },
        "jiraAdminUserName": {
            "type": "string",
            "defaultValue": "admin",
            "minLength": 5,
            "metadata": {
                "description": "The Jira Admin username"
            }
        },
        "jiraAdminUserPassword": {
            "type": "securestring",
            "minLength": 5,
            "metadata": {
                "description": "The Jira Admin password"
            }
        },
        "jiraAdminUserFullname": {
            "type": "string",
            "defaultValue": "Admin Admin",
            "minLength": 5,
            "metadata": {
                "description": "The Jira Admin full name"
            }
        },
        "jiraAdminUserEmail": {
            "type": "string",
            "defaultValue": "admin@example.com",
            "minLength": 5,
            "metadata": {
                "description": "The Jira Admin email address"
            }
        },
        "jiraAppTitle": {
            "type": "string",
            "defaultValue": "Atlassian Jira"
        },
        "clusterSize": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "The number of JIRA nodes in the cluster"
            },
            "minValue": 1
        },
        "sslBase64EncodedPfxCertificate": {
            "type": "string",
            "defaultValue": ""
        },
        "sslPfxCertificatePassword": {
            "type": "securestring",
            "defaultValue": ""
        },
        "appGtwyClusterSize": {
            "type": "int",
            "allowedValues": [
                1,
                2,
                3,
                4,
                5,
                6
            ],
            "defaultValue": 2,
            "minValue": 1,
            "metadata": {
                "description": "The number of nodes for the App Gateway cluster"
            }
        },
        "appGtwyTier": {
            "type": "string",
            "allowedValues": [
                "Standard_Small",
                "Standard_Medium",
                "Standard_Large"
            ],
            "defaultValue": "Standard_Medium",
            "metadata": {
                "description": "The application gateway size"
            }
        },
        "enableEmailAlerts": {
            "type": "bool",
            "defaultValue": true
        },
        "enableApplicationInsights": {
            "type": "bool",
            "defaultValue": true
        },
        "enableAnalytics": {
            "type": "bool",
            "defaultValue": true
        },
        "jiraClusterSize": {
            "type": "string",
            "allowedValues": [
                "",
                "trial",
                "small",
                "medium",
                "large",
                "enterprise"
            ],
            "defaultValue": ""
        }
    },
    "variables": {
        "vpcTemplate": {
            "templateUrl": "[concat(parameters('_artifactsLocation'),'nestedtemplates/azuredeploy-vpc.json')]"
        },
        "jiraTemplate": {
            "templateUrl": "[concat(parameters('_artifactsLocation'),'nestedtemplates/azuredeploy-jira.json')]"
        },
        "domainTemplate": {
            "templateUrl": "[concat(parameters('_artifactsLocation'),'nestedtemplates/azuredeploy-domain.json')]"
        },
        "alertsTemplate": {
            "templateUrl": "[concat(parameters('_artifactsLocation'), 'nestedtemplates/azuredeploy-alerts.json')]"
        },
        "namespace": "jira",
      "dbServerName": "[concat(variables('namespace'), if(equals(parameters('dbType'),'Azure DB for PostgreSQL'),'postgres','sqlserver'), uniqueString(resourceGroup().id))]",
        "isJiraClusterSizeUsed": "[not(empty(parameters('jiraClusterSize')))]",
        "clusterLookup": {
            "appGtwyTier": {
                "trial": "Standard_Small",
                "small": "Standard_Medium",
                "medium": "Standard_Medium",
                "large": "Standard_Large",
                "enterprise": "Standard_Large"
            },
            "appGtwySize": {
                "trial": 1,
                "small": 2,
                "medium": 2,
                "large": 4,
                "enterprise": 6
            },
            "dbTier": {
                "trial": "Basic",
                "small": "Standard",
                "medium": "Standard",
                "large": "Premium",
                "enterprise": "Premium"
            },
            "dbTierSize": {
                "trial": "Basic",
                "small": "S2",
                "medium": "S4",
                "large": "P4",
                "enterprise": "P6"
            },
            "clusterVmSize": {
                "trial": "Standard_DS2_v2",
                "small": "Standard_DS3_v2",
                "medium": "Standard_DS3_v2",
                "large": "Standard_DS4_v2",
                "enterprise": "Standard_DS5_v2"
            },
            "clusterSize": {
                "trial": 1,
                "small": 2,
                "medium": 3,
                "large": 8,
                "enterprise": 10
            },
            "jumpboxVmSize": {
                "trial": "Standard_B1s",
                "small": "Standard_B1s",
                "medium": "Standard_B1s",
                "large": "Standard_B1s",
                "enterprise": "Standard_B1s"
            }
        }
    },
    "resources": [
        {
            "comments": "Azure tracking GUID for Jira - ensure right one being used for the delivery channel ie via Azure Marketplace, BitBucket Quickstart etc",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "pid-a717b299-5535-534f-aecb-a702a63c94bd",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "vpcTemplate",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('vpcTemplate').templateUrl, parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "jumpboxVmSize": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').jumpboxVmSize[parameters('jiraClusterSize')], parameters('jumpboxVmSize'))]"
                    },
                    "jumpboxSshKey": {
                        "value": "[parameters('jumpboxSshKey')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "jiraTemplate",
            "dependsOn": [
                "vpcTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('jiraTemplate').templateUrl, parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "clusterSize": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), int(variables('clusterLookup').clusterSize[parameters('jiraClusterSize')]), parameters('clusterSize'))]"
                    },
                    "clusterVmSize": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').clusterVmSize[parameters('jiraClusterSize')], parameters('clusterVmSize'))]"
                    },
                    "dbCreateNew": {
                        "value": "[parameters('dbCreateNew')]"
                    },
                    "dbHost": {
                        "value": "[if(parameters('dbCreateNew'), variables('dbServerName'), parameters('dbHost'))]"
                    },
                    "dbType": {
                        "value": "[if(equals(parameters('dbType'), 'Azure SQL DB'), 'sqlserver', if(equals(parameters('dbType'), 'Azure DB for PostgreSQL'), 'postgres', 'mysql'))]"
                    },
                    "dbPort": {
                        "value": "[parameters('dbPort')]"
                    },
                    "dbDatabase": {
                        "value": "[parameters('dbDatabase')]"
                    },
                    "dbSchema": {
                        "value": "[parameters('dbSchema')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "dbTier": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').dbTier[parameters('jiraClusterSize')], parameters('dbTier'))]"
                    },
                    "dbTierSize": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').dbTierSize[parameters('jiraClusterSize')], parameters('dbTierSize'))]"
                    },
                    "jiraAppTitle": {
                        "value": "[parameters('jiraAppTitle')]"
                    },
                    "clusterSshUser": {
                        "value": "[parameters('clusterSshUser')]"
                    },
                    "clusterSshPassword": {
                        "value": "[parameters('clusterSshPassword')]"
                    },
                    "cname": {
                        "value": "[if(greater(length(parameters('cname')), 0), concat('jira.', parameters('cname')), parameters('cname'))]"
                    },
                    "jiraAdminUserName": {
                        "value": "[parameters('jiraAdminUserName')]"
                    },
                    "jiraAdminUserPassword": {
                        "value": "[parameters('jiraAdminUserPassword')]"
                    },
                    "jiraAdminUserEmail": {
                        "value": "[parameters('jiraAdminUserEmail')]"
                    },
                    "jiraAdminUserFullname": {
                        "value": "[parameters('jiraAdminUserFullname')]"
                    },
                    "appGtwyClusterSize": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').appGtwySize[parameters('jiraClusterSize')], parameters('appGtwyClusterSize'))]"
                    },
                    "appGtwyTier": {
                        "value": "[if(variables('isJiraClusterSizeUsed'), variables('clusterLookup').appGtwyTier[parameters('jiraClusterSize')], parameters('appGtwyTier'))]"
                    },
                    "vnetName": {
                        "value": "[reference('vpcTemplate').outputs.vnetName.value]"
                    },
                    "appSubnetName": {
                        "value": "[reference('vpcTemplate').outputs.appSubnetName.value]"
                    },
                    "gtwySubnetName": {
                        "value": "[reference('vpcTemplate').outputs.gtwySubnetName.value]"
                    },
                    "jumpboxName": {
                        "value": "[reference('vpcTemplate').outputs.jumpboxName.value]"
                    },
                    "jumpboxPublicIpAddress": {
                        "value": "[reference('vpcTemplate').outputs.jumpboxPublicIpAddress.value]"
                    },
                    "sslBase64EncodedPfxCertificate": {
                        "value": "[parameters('sslBase64EncodedPfxCertificate')]"
                    },
                    "sslPfxCertificatePassword": {
                        "value": "[parameters('sslPfxCertificatePassword')]"
                    },
                    "enableApplicationInsights": {
                        "value": "[parameters('enableApplicationInsights')]"
                    },
                    "enableAnalytics": {
                        "value": "[parameters('enableAnalytics')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "domainTemplate",
            "dependsOn": [
                "jiraTemplate"
            ],
            "condition": "[greater(length(parameters('cname')), 0)]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('domainTemplate').templateUrl, parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "cname": {
                        "value": "[parameters('cname')]"
                    },
                    "gtwyIpName": {
                        "value": "[reference('jiraTemplate').outputs.gtwyIpName.value]"
                    },
                    "prefix": {
                        "value": "jira"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "name": "alertsTemplate",
            "type": "Microsoft.Resources/deployments",
            "condition": "[parameters('enableEmailAlerts')]",
            "dependsOn": [
                "jiraTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('alertsTemplate').templateUrl, parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "jiraAdminUserEmail": {
                        "value": "[parameters('jiraAdminUserEmail')]"
                    },
                    "gtwyName": {
                        "value": "[reference('jiraTemplate').outputs.gtwyName.value]"
                    },
                    "storageAccountName": {
                        "value": "[reference('jiraTemplate').outputs.storageAccountName.value]"
                    },
                    "clusterName": {
                        "value": "[reference('jiraTemplate').outputs.clusterName.value]"
                    },
                    "appInsightsName": {
                        "value": "[reference('jiraTemplate').outputs.appInsightsName.value]"
                    },
                    "statusCheckUrl": {
                        "value": "[concat(if(not(empty(parameters('sslBase64EncodedPfxCertificate'))), concat('https://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value)), concat('http://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value))), '/status')]"
                    },
                    "dbCreateNew": {
                        "value": "[if(equals(parameters('dbCreateNew'), 'Yes (Azure SQL DB Only)'), bool('true'), bool('false'))]"
                    },
                    "dbType": {
                        "value": "[if(equals(parameters('dbType'), 'Azure SQL DB'), 'sqlserver', if(equals(parameters('dbType'), 'Azure DB for PostgreSQL'), 'postgres', 'mysql'))]"
                    },
                    "dbDatabaseServerName": {
                        "value": "[split(reference('jiraTemplate').outputs.dbDatabaseServerName.value, '.')[0]]"
                    },
                    "dbDatabaseName": {
                        "value": "[reference('jiraTemplate').outputs.dbDatabaseName.value]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "appEndpoint": {
            "type": "string",
            "value": "[if(not(empty(parameters('sslBase64EncodedPfxCertificate'))), concat('https://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value)), concat('http://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value)))]"
        },
        "bastionUrl": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.jumpboxPublicEndpoint.value]"
        },
        "sshUrl": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.sshUri.value]"
        },
        "jdbcUrl": {
            "type": "string",
            "value": "[reference('jiraTemplate').outputs.jdbcUrl.value]"
        }
    }
}