{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "northeurope"
        },
        "baseUrl": {
            "type": "string",
            "defaultValue": "https://jiradcresources.blob.core.windows.net/master/",
            "metadata": {
                "description": "Base URL for Marketplace",
                "artifactsBaseUrl": ""
            }
        },
        "provisioningStorageToken": {
            "type": "string",
            "defaultValue": "?sv=2017-04-17&si=public-access&sr=c&sig=P15kxinQOKEJruc4gxMmmKL3EpPZMg137i96w%2BKGB8E%3D",
            "metadata": {
                "description": "Scripts storage access token"
            }
        },
        "cname": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "CNAME to use"
            }
        },
        "jiraVmSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "metadata": {
                "description": "The size of the virtual machine used for each JIRA node."
            }
        },
        "jumpboxVmSize": {
            "type": "string",
            "defaultValue": "Standard_B1s",
            "metadata": {
                "description": "The size of the virtual machine used for the jumpbox box."
            }
        },
        "jumpboxSshKey": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The public key for the jumpbox SSH user"
            }
        },
        "nodeSshUser": {
            "type": "string",
            "defaultValue": "jiraadmin",
            "metadata": {
                "description": "The username used to SSH into each JIRA node from the jumpbox."
            }
        },
        "nodeSshPassword": {
            "type": "securestring",
            "defaultValue": "JIRA@dmin",
            "metadata": {
                "description": "The password used to SSH into each JIRA node from the jumpbox."
            }
        },
        "dbUsername": {
            "type": "string",
            "defaultValue": "jira",
            "metadata": {
                "description": "Database username"
            }
        },
        "dbPassword": {
            "type": "securestring",
            "defaultValue": ".JkvjxaD;K)LKA*7YpbLyWJLPmocWxrcn69",
            "metadata": {
                "description": "Database password"
            }
        },
        "userName": {
            "type": "string",
            "defaultValue": "admin",
            "minLength": 5
        },
        "userCredential": {
            "type": "securestring",
            "defaultValue": "admin"
        },
        "userFullname": {
            "type": "string",
            "defaultValue": "Admin Admin"
        },
        "userEmail": {
            "type": "string",
            "defaultValue": "admin@example.com"
        },
        "applicationTitle": {
            "type": "string",
            "defaultValue": "Atlassian Jira"
        },
        "clusterSize": {
            "type": "int",
            "allowedValues": [
                2,
                3,
                4,
                5,
                6
            ],
            "defaultValue": 2,
            "metadata": {
                "description": "The number of JIRA nodes in the cluster"
            },
            "minValue": 2
        },
        "sslBase64EncodedPfxCertificate": {
            "type": "string",
            "defaultValue": ""
        },
        "sslPfxCertificatePassword": {
            "type": "string",
            "defaultValue": ""
        }
    },
    "variables": {
        "vpcTemplate": {
            "templateUrl": "[concat(parameters('baseUrl'),'azuredeploy-vpc.json')]"
        },
        "jiraTemplate": {
            "templateUrl": "[concat(parameters('baseUrl'),'azuredeploy-jira.json')]"
        },
        "domainTemplate": {
            "templateUrl": "[concat(parameters('baseUrl'),'azuredeploy-domain.json')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "vpcTemplate",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('vpcTemplate').templateUrl, parameters('provisioningStorageToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "jumpboxVmSize": {
                        "value": "[parameters('jumpboxVmSize')]"
                    },
                    "jumpboxSshKey": {
                        "value": "[parameters('jumpboxSshKey')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "jiraTemplate",
            "dependsOn": [
                "vpcTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('jiraTemplate').templateUrl, parameters('provisioningStorageToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "baseUrl": {
                        "value": "[parameters('baseUrl')]"
                    },
                    "provisioningStorageToken": {
                        "value": "[parameters('provisioningStorageToken')]"
                    },
                    "clusterSize": {
                        "value": "[parameters('clusterSize')]"
                    },
                    "jiraVmSize": {
                        "value": "[parameters('jiraVmSize')]"
                    },
                    "dbUsername": {
                        "value": "[parameters('dbUsername')]"
                    },
                    "dbPassword": {
                        "value": "[parameters('dbPassword')]"
                    },
                    "applicationTitle": {
                        "value": "[parameters('applicationTitle')]"
                    },
                    "nodeSshUser": {
                        "value": "[parameters('nodeSshUser')]"
                    },
                    "nodeSshPassword": {
                        "value": "[parameters('nodeSshPassword')]"
                    },
                    "cname": {
                        "value": "[if(greater(length(parameters('cname')), 0), concat('jira.', parameters('cname')), parameters('cname'))]"
                    },
                    "userName": {
                        "value": "[parameters('userName')]"
                    },
                    "userCredential": {
                        "value": "[parameters('userCredential')]"
                    },
                    "userEmail": {
                        "value": "[parameters('userEmail')]"
                    },
                    "userFullname": {
                        "value": "[parameters('userFullname')]"
                    },
                    "vnetName": {
                        "value": "[reference('vpcTemplate').outputs.vnetName.value]"
                    },
                    "appSubnetName": {
                        "value": "[reference('vpcTemplate').outputs.appSubnetName.value]"
                    },
                    "gtwySubnetName": {
                        "value": "[reference('vpcTemplate').outputs.gtwySubnetName.value]"
                    },
                    "jumpboxName": {
                        "value": "[reference('vpcTemplate').outputs.jumpboxName.value]"
                    },
                    "jumpboxPublicIpAddress": {
                        "value": "[reference('vpcTemplate').outputs.jumpboxPublicIpAddress.value]"
                    },
                    "sslBase64EncodedPfxCertificate": {
                        "value": "[parameters('sslBase64EncodedPfxCertificate')]"
                    },
                    "sslPfxCertificatePassword": {
                        "value": "[parameters('sslPfxCertificatePassword')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "name": "domainTemplate",
            "dependsOn": [
                "jiraTemplate"
            ],
            "condition": "[greater(length(parameters('cname')), 0)]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('domainTemplate').templateUrl, parameters('provisioningStorageToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "cname": {
                        "value": "[parameters('cname')]"
                    },
                    "gtwyIpName": {
                        "value": "[reference('jiraTemplate').outputs.gtwyIpName.value]"
                    },
                    "prefix": {
                        "value": "jira"
                    }
                }
            }
        }
    ],
    "outputs": {
        "appEndpoint": {
            "type": "string",
            "value": "[if(not(empty(parameters('sslBase64EncodedPfxCertificate'))), concat('https://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value)), concat('http://', if(greater(length(parameters('cname')), 0), reference('domainTemplate').outputs.alias.value, reference('jiraTemplate').outputs.jiraAppEndpoint.value)))]"
        },
        "bastionUrl": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.jumpboxPublicEndpoint.value]"
        },
        "sshUrl": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.sshUri.value]"
        },
        "jdbcUrl": {
            "type": "string",
            "value": "[reference('jiraTemplate').outputs.jdbcUrl.value]"
        }
    }
}