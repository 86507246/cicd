{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "hascname",
        "type": "Microsoft.Common.OptionsGroup",
        "label": "Do you have an existing registered CNAME?",
        "toolTip": "If you already have a CNAME registered with a domain name provider that you would like to use for your Confluence instance, you can enter it here.",
        "defaultValue": "No",
        "constraints": {
          "allowedValues": [
            {
              "label": "Yes",
              "value": "yes"
            },
            {
              "label": "No",
              "value": "no"
            }
          ]
        }
      },
      {
        "name": "cname",
        "label": "Existing CNAME",
        "type": "Microsoft.Common.TextBox",
        "toolTip": "Once Confluence is deployed, you'll need to update your CNAME record to reference the Confluence endpoint generated by Azure.",
        "constraints": {
          "required": true,
          "regex": "^[a-zA-Z][a-zA-Z0-9\\-]*(?:(?<=[a-zA-Z0-9])\\.[a-zA-Z][a-zA-Z0-9\\-]*)+(?<=[a-zA-Z0-9])$",
          "validationMessage": "You must specify a valid domain name. A valid domain name is one that contains only upper or lower case letters (A-Z, a-z), digits (0-9), or a dash (-) character, and must not start with a digit (0-9) or dash (-) at the beginning or in front of a period (.)"
        },
        "visible": "[equals('yes', basics('hascname'))]"
      }
    ],
    "steps": [
      {
        "name": "administrator",
        "bladeTitle": "Confluence Administration Account",
        "label": "Create a Confluence administrator account. The Confluence instance will be setup with an evaluation license.",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "account",
            "type": "Microsoft.Common.Section",
            "label": "Make a Confluence Administrator Account",
            "elements": [
              {
                "name": "email",
                "label": "Email",
                "type": "Microsoft.Common.TextBox",
                "constraints": {
                  "required": true,
                  "regex": "[^@]+@[^@]+\\.[A-z]{2,4}",
                  "validationMessage": "You must specify an email address"
                }
              },
              {
                "name": "fullname",
                "label": "Full name",
                "type": "Microsoft.Common.TextBox",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a full name"
                }
              },
              {
                "name": "username",
                "label": "Username",
                "toolTip": "A Confluence administrator account with this username will be automatically created during deployment. Login using this username to continue customizing your Confluence instance.",
                "type": "Microsoft.Compute.UserNameTextBox",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "password",
                "toolTip": "The password for the Confluence administrator account.",
                "label": {
                  "password": "Password",
                  "confirmPassword": "Confirm password"
                },
                "type": "Microsoft.Common.PasswordBox",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a password"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "infrastructure",
        "bladeTitle": "Confluence node configuration",
        "label": "Set up your Confluence nodes",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "confluence",
            "type": "Microsoft.Common.Section",
            "label": "Confluence Cluster",
            "elements": [
              {
                "name": "confluenceclustersize",
                "label": "Number of Confluence nodes",
                "type": "Microsoft.Common.TextBox",
                "defaultValue": "2",
                "toolTip": "Pick how many Confluence nodes to run in the cluster.",
                "constraints": {
                  "required": true,
                  "regex": "^[1-6]$",
                  "validationMessage": "Supported cluster sizes are between 1 and 6 nodes"
                }
              },
              {
                "name": "confluencenodesize",
                "label": "Confluence Node size",
                "type": "Microsoft.Compute.SizeSelector",
                "toolTip": "Pick the virtual machine size to use for each node.",
                "recommendedSizes": [
                  "Standard_DS3_v2"
                ],
                "constraints": {
                  "excludedSizes": [
                    "Standard_A0",
                    "Standard_A1",
                    "Standard_A2",
                    "Standard_A3",
                    "Standard_A4",
                    "Standard_A5",
                    "Standard_A6",
                    "Standard_A7",
                    "Standard_A1_v2",
                    "Standard_A2_v2",
                    "Standard_A2m_v2",
                    "Standard_B1s",
                    "Standard_B1ms",
                    "Standard_B2s",
                    "Standard_B2ms",
                    "Standard_F1",
                    "Standard_F2",
                    "Standard_F4",
                    "Standard_F8",
                    "Standard_F16",
                    "Standard_F1s",
                    "Standard_F2s_v2",
                    "Standard_D1",
                    "Standard_DS1",
                    "Standard_D1_v2",
                    "Standard_DS1_v2",
                    "Standard_D2_v3",
                    "Standard_D2s_v3",
                    "Standard_E2s_v3",
                    "Standard_E2_v3",
                    "Standard_GS1",
                    "Standard_G1",
                    "Standard_DS11",
                    "Standard_DS11_v2",
                    "Standard_D11_v2",
                    "Standard_D11"
                  ]
                },
                "osPlatform": "Linux",
                "imageReference": {
                  "publisher": "Canonical",
                  "offer": "UbuntuServer",
                  "sku": "17.04"
                },
                "count": "[steps('infrastructure').confluence.confluenceclustersize]"
              },
              {
                "name": "natsize",
                "label": "Jumpbox size",
                "type": "Microsoft.Compute.SizeSelector",
                "toolTip": "Pick the virtual machine size to use for the jump box. The vm must have a minimum of 3 NIC slots.",
                "recommendedSizes": [
                  "Standard_DS3_v2"
                ],
                "constraints": {
                  "allowedSizes": [
                    "Standard_D8s_v3",
                    "Standard_D16s_v3",
                    "Standard_D32s_v3",
                    "Standard_D64s_v3",
                    "Standard_D8_v3",
                    "Standard_D16_v3",
                    "Standard_D32_v3",
                    "Standard_D64_v3",
                    "Standard_DS3_v2",
                    "Standard_DS4_v2",
                    "Standard_DS5_v2",
                    "Standard_D3_v2",
                    "Standard_D4_v2",
                    "Standard_D5_v2",
                    "Standard_DS3",
                    "Standard_DS4",
                    "Standard_D3",
                    "Standard_D4",
                    "Standard_A4_v2",
                    "Standard_A8_v2",
                    "Standard_A4m_v2",
                    "Standard_A8m_v2",
                    "Standard_A4",
                    "Standard_A7",
                    "Standard_B2s",
                    "Standard_B2ms",
                    "Standard_B4ms",
                    "Standard_B8ms",
                    "Standard_F4s",
                    "Standard_F8s",
                    "Standard_F16s",
                    "Standard_F4",
                    "Standard_F8",
                    "Standard_F16",
                    "Standard_E8s_v3",
                    "Standard_E16s_v3",
                    "Standard_E32s_v3",
                    "Standard_E64s_v3",
                    "Standard_E8_v3",
                    "Standard_E16_v3",
                    "Standard_E32_v3",
                    "Standard_E64_v3",
                    "Standard_GS3",
                    "Standard_GS4",
                    "Standard_GS5",
                    "Standard_G3",
                    "Standard_G4",
                    "Standard_G5",
                    "Standard_DS12_v2",
                    "Standard_DS13_v2",
                    "Standard_DS14_v2",
                    "Standard_DS15_v2",
                    "Standard_D12_v2",
                    "Standard_D13_v2",
                    "Standard_D14_v2",
                    "Standard_D15_v2",
                    "Standard_DS12",
                    "Standard_DS13",
                    "Standard_DS14",
                    "Standard_D12",
                    "Standard_D13",
                    "Standard_D14",
                    "Standard_L8s",
                    "Standard_L16s",
                    "Standard_L32s"
                  ]
                },
                "osPlatform": "Linux",
                "imageReference": {
                  "publisher": "Canonical",
                  "offer": "UbuntuServer",
                  "sku": "17.04"
                }
              }
            ]
          },
          {
            "name": "synchrony",
            "type": "Microsoft.Common.Section",
            "label": "Synchrony Cluster",
            "elements": [
              {
                "name": "synchronyVmOption",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Choose Synchrony Cluster Size",
                "defaultValue": "Automatic",
                "toolTip": "Choose 'Automatic' to automatically select the best Synchrony cluster size and type based on your Confluence cluster.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Automatic",
                      "value": "auto"
                    },
                    {
                      "label": "Manual",
                      "value": "manual"
                    }
                  ]
                }
              },
              {
                "name": "synchronyclustersize",
                "label": "Number of Synchrony nodes",
                "type": "Microsoft.Common.TextBox",
                "defaultValue": "2",
                "toolTip": "Pick how many Synchrony nodes to run in the cluster.",
                "constraints": {
                  "required": true,
                  "regex": "^[1-6]$",
                  "validationMessage": "Supported cluster sizes are between 1 and 6 nodes"
                },
                "visible": "[equals('manual', steps('infrastructure').synchrony.synchronyVmOption)]"
              },
              {
                "name": "synchronynodesize",
                "label": "Synchrony Node size",
                "type": "Microsoft.Compute.SizeSelector",
                "toolTip": "Pick the virtual machine size to use for each node.",
                "recommendedSizes": [
                  "Standard_DS3_v2"
                ],
                "osPlatform": "Linux",
                "imageReference": {
                  "publisher": "Canonical",
                  "offer": "UbuntuServer",
                  "sku": "17.04"
                },
                "count": "[steps('infrastructure').synchrony.synchronyclustersize]",
                "visible": "[equals('manual', steps('infrastructure').synchrony.synchronyVmOption)]"
              }
            ]
          }
        ]
      },
      {
        "name": "database",
        "bladeTitle": "Database admin",
        "label": "Set up the database admin account, and select database tier",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "username",
            "type": "Microsoft.Common.TextBox",
            "label": "Username",
            "constraints": {
              "required": true,
              "regex": "^(?!admin$|administrator$|sa$|root$|dbmanager$|loginmanager$|dbo$|guest$|information_schema$|sys$|db_accessadmin$|db_backupoperator$|db_datareader$|db_datawriter$|db_ddladmin$|db_denydatareader$|db_denydatawriter$|db_owner$|db_securityadmin$|public$)[a-zA-Z][a-zA-Z0-9]{1,9}$",
              "validationMessage": "This username needs to be a SQL Identifier - it can't be a typical username like admin, adminstrator, sa, root, dbmanager, loginmanager, dbo, guest, or public. It also can't begin with numbers or symbols, and can't include whitespaces, unicode characters, or non-alphabetic characters."
            }
          },
          {
            "name": "password",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "constraints": {
              "required": true,
              "regex": "^(?=.*[A-Z])(?=.*[.!@#$%])(?=.*[0-9])(?=.*[a-z]).{16,41}$",
              "validationMessage": "This password must be between 16 and 41 characters long, and must contain at least one uppercase letter, one lowercase letter, one number (0-9), and one non-alphanumeric character (., !, $, #, %, etc.)."
            }
          },
          {
            "name": "dbTierOption",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Database Tier Option",
            "toolTip": "The Automatic option will use a Premium RS type and Performance Level suitable for the number of Confluence nodes selected. You may also select the Manual option to control your database performance & cost. Consider consulting the Azure Pricing Calculator.",
            "defaultValue": "Automatic",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Automatic",
                  "value": "auto"
                },
                {
                  "label": "Manual",
                  "value": "manual"
                }
              ]
            }
          },
          {
            "name": "dbTier",
            "label": "Manual Database Tier Selection",
            "type": "Microsoft.Common.DropDown",
            "toolTip": "Manually pick the Database Tier.",
            "defaultValue": "",
            "constraints": {
              "required" : "[equals('manual', steps('database').dbTierOption)]",
              "allowedValues": [
                {
                  "label": "S2",
                  "value": "S2"
                },
                {
                  "label": "S3",
                  "value": "S3"
                },
                {
                  "label": "P1",
                  "value": "P1"
                },
                {
                  "label": "P2",
                  "value": "P2"
                },
                {
                  "label": "P4",
                  "value": "P4"
                },
                {
                  "label": "P6",
                  "value": "P6"
                },
                {
                  "label": "P11",
                  "value": "P11"
                },
                {
                  "label": "P15",
                  "value": "P15"
                },
                {
                  "label": "PRS1",
                  "value": "PRS1"
                },
                {
                  "label": "PRS2",
                  "value": "PRS2"
                },
                {
                  "label": "PRS3",
                  "value": "PRS3"
                },
                {
                  "label": "PRS4",
                  "value": "PRS4"
                },
                {
                  "label": "PRS5",
                  "value": "PRS5"
                },
                {
                  "label": "PRS6",
                  "value": "PRS6"
                }
              ]
            },
            "visible": "[equals('manual', steps('database').dbTierOption)]"
          },
          {
            "name": "dbEdition",
            "label": "Manual Database Edition Selection",
            "type": "Microsoft.Common.DropDown",
            "toolTip": "Manually pick the Database Edition.",
            "defaultValue": "",
            "constraints": {
              "required" : "[equals('manual', steps('database').dbTierOption)]",
              "allowedValues": [
                {
                  "label": "Standard",
                  "value": "Standard"
                },
                {
                  "label": "Premium",
                  "value": "Premium"
                },
                {
                  "label": "PremiumRS",
                  "value": "PremiumRS"
                }
              ]
            },
            "visible": "[equals('manual', steps('database').dbTierOption)]"
          }
        ]
      },
      {
        "name": "ssh",
        "bladeTitle": "SSH access",
        "label": "Set up SSH access",
        "subLabel": {
          "preValidation": "To do",
          "postValidation": "Done"
        },
        "elements": [
          {
            "name": "jumpbox",
            "label": "Set up access to the jumpbox",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "jumpboxUsername",
                "label": "Username",
                "type": "Microsoft.Compute.UserNameTextBox",
                "toolTip": "This will be the username used to SSH into the jumpbox from your own machine.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify an SSH username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "credentials",
                "type": "Microsoft.Compute.CredentialsCombo",
                "osPlatform": "Linux",
                "label": {
                  "authenticationType": "",
                  "password": "",
                  "confirmPassword": "",
                  "sshPublicKey": "Public key"
                },
                "toolTip": {
                  "authenticationType": "",
                  "password": "",
                  "sshPublicKey": "This will be the public key used to SSH into the jumpbox from your own machine."
                },
                "options": {
                  "hidePassword": true
                },
                "constraints": {
                  "required": true
                }
              }
            ]
          },
          {
            "name": "node",
            "label": "Set up access to Confluence and Synchrony nodes",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "nodeUsername",
                "label": "Username",
                "type": "Microsoft.Compute.UserNameTextBox",
                "toolTip": "This will be the username used to SSH into each Confluence and Synchrony node from the jumpbox.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a username"
                },
                "osPlatform": "Linux"
              },
              {
                "name": "nodePassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Password",
                  "confirmPassword": "Confirm password"
                },
                "toolTip": "This will be the password used to SSH into each Confluence and Synchrony node from the jumpbox.",
                "constraints": {
                  "required": true,
                  "validationMessage": "You must specify a password"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "location" : "[location()]",
      "cname": "[basics('cname')]",
      "confluenceVmSize": "[steps('infrastructure').confluence.confluencenodesize]",
      "synchronyVmSize": "[coalesce(steps('infrastructure').synchrony.synchronynodesize, steps('infrastructure').confluence.confluencenodesize)]",
      "synchronyVmOption": "[steps('infrastructure').synchrony.synchronyVmOption]",
      "natVmSize": "[steps('infrastructure').confluence.natsize]",
      "dbTierOption": "[steps('database').dbTierOption]",
      "dbTier": "[steps('database').dbTier]",
      "dbEdition": "[steps('database').dbEdition]",
      "jumpboxSshUser": "[steps('ssh').jumpbox.jumpboxUsername]",
      "jumpboxSshKey": "[steps('ssh').jumpbox.credentials.sshPublicKey]",
      "nodeSshUser": "[steps('ssh').node.nodeUsername]",
      "nodeSshPassword": "[steps('ssh').node.nodePassword]",
      "dbUsername": "[steps('database').username]",
      "dbPassword": "[steps('database').password]",
      "userName": "[steps('administrator').account.username]",
      "userFullname": "[steps('administrator').account.fullname]",
      "userEmail": "[steps('administrator').account.email]",
      "userCredential": "[steps('administrator').account.password]",
      "clusterSize": "[int(steps('infrastructure').confluence.confluenceclustersize)]",
      "synchronyClusterSize": "[int(coalesce(steps('infrastructure').synchrony.synchronyclustersize, 2))]"
    }
  }
}